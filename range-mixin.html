<script>
  /**
   * mixin to provide a range behavior for a given value
   *
   * @mixinFunction
   * @polymer
   */
  const RangeMixin = (superClass) => { // eslint-disable-line no-unused-vars

    return class extends superClass {

      static get properties() {
        return {
          /**
           * minimal input
           * @type {number}
           */
          min: {
            type: Number
          },
          /**
           * maximal input
           * @type {number}
           */
          max: {
            type: Number
          },
          /**
           * step for changing the input (referencing to `min` or `0`)
           * @type {number}
           */
          step: {
            type: Number,
            value: 1
          },
          /**
           * value of the input
           * @type {number}
           */
          value: {
            type: Number,
            notify: true,
            observer: '_valueChanged'
          },
          /**
           * if true, the value does not overflow the maximum or underflow the minimum
           * @type {boolean}
           */
          saturate: {
            type: Boolean
          }
        }
      }

      _valueChanged(value, oldValue) {
        if (value === undefined) return;

        value = this._checkValue(value, oldValue, this.min, this.max);

        if (value !== this.value) {
          this.value = value;
          return;
        }
      }

      _checkValue(value, oldValue, min, max) {
        if (isNaN(value)) {
          if (!isNaN(oldValue)) {
            return oldValue;
          }
          return min || max || 0;
        }
        const saturate = this.saturate;
        if (min !== undefined && value <= min) {
          if (saturate || max === undefined || oldValue !== min) {
            return min;
          }
          return max;
          // return this._checkStep(max, this.step, min, max);
        }
        if (max !== undefined && value >= max) {
          // max = this._checkStep(max, this.step, min, max);
          if (saturate || min === undefined || max !== oldValue) {
            return max;
          }
          return min;
        }
        return this._checkStep(value, this.step, min, max);
      }

      _checkStep(value, step, min, max) {
        if (!step) {
          return value;
        }
        if (min !== undefined) {
          return this._safeAdd(this._safeMult(Math.round((value - min) / step), step), min);
        }
        if (max !== undefined) {
          return this._safeAdd(this._safeMult(-Math.round((max - value) / step), step), max);
        }
        return this._safeAdd(this._safeMult(Math.round(value / step), step), 0);
      }

      /**
       * emulating handwritten multiplication
       * @param  {[number]} a [factor]
       * @param  {[number]} b [factor]
       * @return {[type]}   [product]
       */
      _safeMult(a, b) {
        a = '' + (a || 0);
        b = '' + (b || 0);

        const aDecimal = a.slice(a.indexOf('.')).length - 1;
        const bDecimal = b.slice(b.indexOf('.')).length - 1;

        const decimal = aDecimal + bDecimal;
        const endSign = (a[0] === '-' ? b[0] !== '-' : b[0] === '-') ? '-' : '';

        a = a.replace(/\D/g, '');
        b = b.replace(/\D/g, '');

        let whole = 0;
        for (let i = 0; i < b.length; i++) {
          whole += Math.pow(10, b.length - 1 - i) * Number(a) * Number(b[i]);
        }
        whole = this._format(whole, decimal, 0);
        return Number(endSign + whole.slice(0, whole.length - decimal) + '.' + whole.slice(whole.length - decimal));
      }

      /**
       * emulating handwritten addition
       * @param  {[number]} a [summand]
       * @param  {[number]} b [summand]
       * @return {[type]}   [sum]
       */
      _safeAdd(a, b) {
        a = '' + (a || 0);
        b = '' + (b || 0);

        const aDecimal = a.slice(a.indexOf('.')).length - 1;
        const bDecimal = b.slice(b.indexOf('.')).length - 1;

        const decimal = Math.max(aDecimal, bDecimal);

        let whole = Math.round( Math.pow(10, decimal) * Number(a) +
                                Math.pow(10, decimal) * Number(b) );
        whole = this._format(whole, decimal, 0);
        return Number(whole.slice(0, whole.length - decimal) + '.' + whole.slice(whole.length - decimal));
      }

    }
  }
</script>
